---
- name: Patch Kubernetes nodes with providerID
  hosts: localhost
  gather_facts: no
  vars:
    instance_list_file: "./{{ cluster_name }}/instance_list.json"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    - name: Load instance list from file
      ansible.builtin.read_json:
        path: "{{ instance_list_file }}"
      register: instances
      failed_when: instances is not defined or instances | length == 0

    - name: Patch all nodes with providerID
      ansible.builtin.shell: |
        kubectl patch node {{ item.name }} -p '{"spec": {"providerID": "ibmpowervs://{{ powervs_region }}/{{ powervs_zone }}/{{ powervs_ws }}/{{ item.id }}"}}'
      loop: "{{ instances }}"
      loop_control:
        label: "{{ item.name }}"  # Makes output clearer
      when: item.name is defined and item.id is defined  # Ensure both are present
      register: node_patch_results
      changed_when: false  # Prevents task from always showing as changed
      retries: 3  # Retry up to 3 times in case of failure
      delay: 5  # Add a 5-second delay between retries
      until: node_patch_results is success  # Ensure that patching was successful

    - name: Show results from node patching
      debug:
        var: node_patch_results.results
      when: node_patch_results is defined