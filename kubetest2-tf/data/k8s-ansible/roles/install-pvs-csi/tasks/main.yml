---
- name: Debug current working directory
  command: pwd
  register: current_dir

- name: Show current working directory
  debug:
    msg: "Current directory: {{ current_dir.stdout }}"

- name: List files in current directory
  command: ls -la
  register: ls_output

- name: Show files in current directory
  debug:
    msg: "{{ ls_output.stdout_lines }}"

- name: List cluster directory
  command: ls -la ./{{ cluster_name }}
  register: cluster_ls
  ignore_errors: true

- name: Show cluster directory contents
  debug:
    msg: "{{ cluster_ls.stdout_lines }}"

- name: Load instance list from file
  set_fact:
    instances: "{{ lookup('file', './instance_list.json') | from_json }}"
  failed_when: instances is not defined or instances | length == 0

- name: Patch all nodes with providerID
  ansible.builtin.shell: |
    kubectl patch node {{ item.name }} -p '{"spec": {"providerID": "ibmpowervs://{{ powervs_region }}/{{ powervs_zone }}/{{ powervs_ws }}/{{ item.id }}"}}'
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.name is defined and item.id is defined
  register: node_patch_results
  retries: 3
  delay: 5
  until: node_patch_results is success

- name: Show results from node patching
  debug:
    var: node_patch_results.results
  when: node_patch_results is defined