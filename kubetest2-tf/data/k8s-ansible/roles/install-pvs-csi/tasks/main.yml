---
- name: Wait until at least one node exists
  command: kubectl get nodes -o=name
  register: nodes_result
  retries: 30
  delay: 10
  until: nodes_result.stdout_lines | length > 0
  ignore_errors: yes

- name: Show active nodes
  debug:
    msg: "Active nodes: {{ nodes_result.stdout_lines }}"

- name: Fail if no nodes became active
  fail:
    msg: "No Kubernetes nodes became active after {{ retries }} attempts"
  when: nodes_result.stdout_lines | length == 0

- name: Load instance list from file
  set_fact:
    instances: "{{ lookup('file', './instance_list.json') | from_json }}"
  failed_when: instances is not defined or instances | length == 0

- name: Patch all nodes with providerID
  ansible.builtin.shell: |
    kubectl patch node {{ item.name }} -p '{"spec": {"providerID": "ibmpowervs://{{ powervs_region }}/{{ powervs_zone }}/{{ powervs_ws }}/{{ item.id }}"}}'
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.name is defined and item.id is defined
  register: node_patch_results
  retries: 3
  delay: 5
  until: node_patch_results is success

- name: Show results from node patching
  debug:
    var: node_patch_results.results
  when: node_patch_results is defined